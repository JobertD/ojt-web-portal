<!DOCTYPE html>
<html lang="en">
<head>
   <meta charset="UTF-8">
   <meta http-equiv="X-UA-Compatible" content="IE=edge">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Home - OJT Portal</title>

   <!-- font awesome cdn link  -->
   <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css">

   <!-- custom css file link  -->
   <link rel="stylesheet" type="text/css" href="/css/style.css">

</head>
<body>
<header class="header">
   
   <section class="flex">

      <a href="/homepage" class="logo">OJT Portal</a>


      <div class="icons">
         <div id="menu-btn" class="fas fa-bars"></div> 
         <div id="search-btn" class="fas fa-search"></div>
         <div id="toggle-btn" class="fas fa-sun"></div>
      </div>

   </section>

</header>   

<div class="side-bar">

   <div id="close-btn">
      <i class="fas fa-times"></i>
   </div>

   <div class="profile">
      <img src="/images/pic-1.jpg" class="image" alt="">
      <h1 class="name"><%= fullName %></h1>
      <p class="role">Teacher</p>
      <a href="/profile" class="btn">view profile</a>
   </div>

   <nav class="navbar">
      <a href="/homepage"><i class="fas fa-home"></i><span>Home</span></a>
      <a href="/manage-students"><i class="fa-solid fa-briefcase"></i><span>Manage Students</span></a>
      <a href="/company-details"><i class="fa-solid fa-door-open"></i><span>Company Details</span></a>
      <a href="/logout"><i class="fa-solid fa-door-open"></i><span>Log Out</span></a>
    </nav>

</div>

<section class="manage-grid">
    <h1 class="heading">Manage Students</h1>
   <div class="manage-container">
       <div class="box">
           <h1 class="title">Student List</h1>
           <form id="filterForm">
               <label for="searchQuery">Search:</label>
               <input type="text" id="searchQuery" name="searchQuery" placeholder="Enter search query...">
               <button type="button" onclick="submitSearch()">Search</button>
           </form>
           <table id="studentTable">
               <thead>
                   <tr>
                       <th>Student ID</th>
                       <th>Name</th>
                       <th>Email</th>
                       <th>Course</th>
                       <th>Class Code</th>
                       <th>Company</th>
                   </tr>
               </thead>
               <tbody id="tableBody"></tbody>
           </table>
       </div>
   </div>

<script>
    window.onload = function () {
      fetchAllStudents();
   }

   function fetchAllStudents() {
      fetch('/fetch-all-students')
         .then(response => response.json())
         .then(data => populateTable(data))
         .catch(error => console.error('Error:', error));
   }

   function submitSearch() {
      const searchQuery = document.getElementById('searchQuery').value.trim();
      fetch(`/search-students?query=${searchQuery}`)
         .then(response => response.json())
         .then(data => populateTable(data))
         .catch(error => console.error('Error:', error));
   }

   function populateTable(data) {
    const tableBody = document.getElementById('tableBody');
    tableBody.innerHTML = ''; 

    data.forEach(student => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${student.studentId}</td>
            <td>${student.fullName}</td>
            <td>${student.email}</td>
            <td>${student.course}</td>
            <td>${student.classCode}</td>
            <td>${student.company}</td>
        `;
        row.setAttribute("data-student-id", student.studentId); // Add a data attribute
        row.addEventListener("click", function() { selectRow(this); });
        tableBody.appendChild(row);
    });
   }

function selectRow(row) {
    // Remove highlighting from all rows
    document.querySelectorAll('#studentTable tr').forEach(tr => {
        tr.classList.remove('highlighted');
    });

    // Highlight the selected row
    row.classList.add('highlighted');

    const studentId = row.getAttribute('data-student-id');  
    console.log('Selected Student ID:', studentId);

    // Fetch Requirements
    fetch(`/student-requirements?studentId=${studentId}`)
        .then(response => response.json())
        .then(data => updateRequirementsUI(data))
        .catch(error => console.error('Error:', error));

    // Fetch Reports
    fetch(`/student-reports?studentId=${studentId}`)
        .then(response => response.json())
        .then(reports => updateReportsTable(reports))
        .catch(error => console.error('Error:', error));
   }

   function updateRequirementsUI(data) {
    const statusToText = (status) => {
        switch(status) {
            case 0: return 'Missing';
            case 1: return 'Reviewing';
            case 2: return 'Approved';
            default: return 'Unknown';
        }
    };

    document.querySelector(".requirements.job-resume span").textContent = statusToText(data.jobResume);
    document.querySelector(".requirements.curriculum-vitae span").textContent = statusToText(data.curriVitae);
    document.querySelector(".requirements.cover-letter span").textContent = statusToText(data.coverLetter);
    document.querySelector(".requirements.moa span").textContent = statusToText(data.moa);
    document.querySelector(".requirements.medical-certificate span").textContent = statusToText(data.medCert);
    document.querySelector(".requirements.waiver span").textContent = statusToText(data.waiver);
}

function updateReportsTable(reports) {
    let reportsTableBody = document.querySelector("#reportsTable tbody");
    if (reportsTableBody) {
        reportsTableBody.innerHTML = ''; // Clear existing rows

        reports.forEach(report => {
            let row = document.createElement('tr');
            row.innerHTML = `
                <td>${report.weekNum}</td>
                <td>${report.hoursWorked}</td>
                <td>${new Date(report.submittedAt).toLocaleDateString()}</td>
                <td><a href="${report.reportFile.replace('/public', '')}" target="_blank">Show File</a></td>
                <td>${report.demerit || 'N/A'}</td>
            `;
            reportsTableBody.appendChild(row);
        });
    } else {
        console.error('Reports table body not found');
    }
}


</script>
<div class="manage-container">
   <div class="box">
       <h1 class="title">Manage Student</h1>
       <h5>Requirements:</h5>
       <p class="requirements job-resume">Job Resume: <span></span></p>
       <p class="requirements curriculum-vitae">Curriculum Vitae: <span></span></p>
       <p class="requirements cover-letter">Cover Letter: <span></span></p>
       <p class="requirements moa">MOA: <span> </span></p>
       <p class="requirements medical-certificate">Medical Certificate: <span> </span></p>
       <p class="requirements waiver">Waiver: <span> </span></p>

       <h5>Reports to be reviewed</h5>
       <table id="reportsTable">
         <thead>
             <tr>
                 <th>Week</th>
                 <th>Hours Worked</th>
                 <th>Submitted</th>
                 <th>File</th>
                 <th>Demerit</th>
             </tr>
         </thead>
         <tbody>
             <!-- Rows will be added here dynamically -->
         </tbody>
     </table>
     

       <h5>Reports History</h5>
       <ul>
           <!-- Report history will be populated dynamically -->
       </ul>
   </div>
</div>
</section>
     
<footer class="footer">

   &copy; Copyright @ 2023 by <span>The Croods</span> | All rights reserved!

</footer>
<script src="/js/script.js"></script>
<script>
   console.log('fullName:', '<%= fullName %>');
</script>

   
</body>
</html>